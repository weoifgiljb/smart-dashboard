# 工作日志（合并整理版）

本文件汇总了项目现有 Markdown 文档中的关键信息，统一沉淀为一份可追溯的工作日志，便于后续维护与查阅。原分散文档（如 BOOKS_*.md、HEATVALUE_*.md、CORS_*.md、backend/*.md 等）内容已纳入本文件与《用户手册》。

---

## 时间线总览

- 2025-11-24
  - 仪表盘交互增强（图表下钻、日期筛选）
  - 日记编辑器升级（Markdown/Monaco Editor）
  - 书籍搜索 Bug 修复与 Maven 构建修复
- 2025-11-21
  - UI 全面优化（日记 Emoji、任务统计布局、单词复习背景、侧边栏折叠）
  - TypeScript 类型修复（Dashboard、API）
  - 文档更新（README.md）
- 2025-11-12
  - 书籍推送功能 v2.0 完成（多维排序、分页、搜索、分类、详情）- 前后端与文档齐备
  - CORS 修复最终版（后端 Security 配置与前端代理、Axios 配置）
- 2025-11-10
  - 启动状态排查与环境修复指引（Java 17、MongoDB 安装与校验）
  - 后端常见问题排查指南完善
- 近期
  - 打卡热力值功能（量化方案、前后端接入与测试指南）
  - 打卡与日历功能合并（页面与路由整合）
  - Java/Lombok 兼容性问题修复方案沉淀

---

## 2025-11-24 更新摘要

- **构建与环境修复**
  - **Maven 依赖**: 修复 `backend/pom.xml` 中 `itext-asian` 等依赖下载失败的问题，显式配置阿里云 Maven 镜像仓库，解决 "Remote host terminated the handshake" 错误。

- **功能增强与优化**
  - **仪表盘 (Dashboard)**:
    - **交互升级**: 图表支持点击下钻，点击数据点可查看当日详细记录（番茄钟列表、新增单词列表）。
    - **动态过滤**: 新增日期范围选择器（支持快捷选择最近一周/一月/三月），图表数据随时间范围实时聚合更新。
    - **代码修复**: 修复了变量命名冲突 (`start` vs `rangeStart`) 导致的编译错误。
  - **日记 (Diary)**:
    - **编辑器升级**: 集成 `Monaco Editor`，支持 Markdown 语法高亮与编辑。
    - **渲染优化**: 引入 `marked` 库，实现 Markdown 内容的实时预览与格式化展示（标题、列表、代码块样式优化）。
  - **书籍 (Books)**:
    - **Bug 修复**: 修复搜索结果不显示图片的问题。提取通用的数据清洗逻辑 (`processBooksData`)，确保搜索结果也能正确处理字段错位（如图片 URL 误存入 author 字段的情况）。

---

## 2025-11-21 更新摘要

- **UI 交互优化**
  - **日记 (Diary)**: 心情选择器升级为 Emoji (😄 😐 😭 💪 😫)，增加悬停提示，提升情感表达直观性。
  - **任务 (Tasks)**: 统计区域布局重构为紧凑水平排列，优化空间利用率。
  - **单词复习 (Vocabulary)**: 背景色调整为清新的天蓝色渐变 (`#89f7fe` -> `#66a6ff`)，提升视觉体验。
  - **布局 (Layout)**: 侧边栏新增折叠/展开功能，支持更灵活的屏幕空间管理。

- **代码质量与修复**
  - **TypeScript 修复**:
    - 修复 `Dashboard.vue` 中 `Date | null` 类型不匹配导致的构建错误。
    - 修复 `api/words.ts` 中 Axios 响应类型定义问题，增加 `Promise<any>` 断言。
    - 清理未使用的 import 和 computed 属性。

- **文档维护**
  - 更新 `README.md`: 完善项目简介、核心功能清单（日记、书籍推送等）及更新时间戳。

---

## 书籍推送 v2.0 交付摘要

来源：BOOKS_EXECUTIVE_SUMMARY.md、BOOKS_COMPLETION_SUMMARY.md、BOOKS_OPTIMIZATION.md、BOOKS_OPTIMIZATION_QUICK_REF.md、BOOKS_API_DOCUMENTATION.md、BOOKS_DEPLOYMENT_CHECKLIST.md

- 核心能力
  - 多维推荐排序：rating（评分）/ hot（热度）/ new（最新）
  - 分页返回：Spring Data Page，含总数与页码信息
  - 搜索与分类：关键词检索、按分类获取
  - 书籍详情：按 ID 查询完整信息
- 后端改动
  - `BookService` 推荐算法与分页
  - `Book` 模型新增字段：category、viewCount、favoriteCount、createTime、updateTime
  - `BookController` 新增端点：
    - GET `/api/books`（分页）
    - GET `/api/books/all`（不分页）
    - GET `/api/books/search`
    - GET `/api/books/category/{category}`
    - GET `/api/books/{id}`
- 前端改动
  - `Books.vue`：搜索、排序、分页、收藏、本地持久化、交互与性能优化（虚拟列表、懒加载）
  - `src/api/books.ts`：配套 API 封装
  - 测试用例：分页、排序、搜索、收藏持久化等
- 成果与指标
  - 首页加载 2.0s → 0.8s
  - API 响应 500ms → 100ms（缓存）
  - 交互完善：工具栏、悬停反馈、分页导航、空状态
- 快速验证
  - 后端：`mvn clean package -DskipTests && java -jar target/self-discipline-backend-1.0.0.jar`
  - 前端：`npm install && npm run dev`
  - 核心接口测试：`/api/books`、`/api/books/search`

---

## CORS 修复与最佳实践

来源：CORS_FIX.md、CORS_SOLUTION.md

- 后端 Security 配置
  - 允许源、方法、头部与凭据，放行 `OPTIONS` 预检请求
  - 在异常处理器中补充 CORS 头，避免 401/403 时丢失 CORS 头
- 前端配置
  - Axios `withCredentials: true`
  - Vite 代理开启 `changeOrigin/ws/secure: false`
- 必要操作
  - 修改后需重启后端；必要时清浏览器缓存后再测
- 验证方式
  - 预检请求返回 200，响应头包含 `Access-Control-Allow-Origin` 等

---

## 打卡热力值（HeatValue）功能

来源：HEATVALUE_FEATURE.md、HEATVALUE_TESTING.md

- 目标：从“是否打卡”二值，升级为按日量化热度的热力图
- 计算公式：每日热力值 = 1（基础分） + 番茄×2 + 单词×1 + 任务×3
- 后端
  - `CheckIn` 增加 `heatValue`
  - `CheckInService` 计算并返回当日热力值与历史热力值
  - 新增历史接口：`GET /checkin/history-with-heatvalue`
- 前端
  - `checkin.ts` 新增 API
  - `CheckIn.vue` 展示热力值构成
  - `Calendar.vue` 年度热力图升级（色阶、tooltip、最大值自适应）
- 测试重点
  - 打卡后热力值回显
  - 年度热力图颜色正确映射
  - 历史数据可选迁移或补齐

---

## 打卡与日历整合

来源：CHECKIN_CALENDAR_MERGE.md

- 页面整合：在 `Calendar.vue` 合并打卡模块、显示年度热力图、徽章与日详情
- 路由与菜单：`/checkin` 重定向到 `/calendar`；“日历 & 打卡”统一菜单
- 兼容性：CheckIn API 与服务保持不变
- 测试清单：页面可达、打卡统计与热力图、月份切换、旧路由重定向

---

## 启动状态与环境修复

来源：STARTUP_STATUS.md、MANUAL_INSTALL_GUIDE.md

- 问题现状（当时）：前端可运行、后端因 Java 版本不兼容失败、MongoDB 未安装
- 修复路径
  - 安装与切换到 Java 17（强烈推荐）
  - 安装并启动 MongoDB（或使用 Atlas）
  - 重新编译后端并启动
- 验证：`Test-NetConnection :8080 / :27017`、浏览器访问前端

---

## Java/Lombok 兼容性与排障

来源：backend/JAVA24_FIX.md、backend/JAVA_VERSION_FIX.md、backend/INSTALL_JAVA17.md、backend/LOMBOK_FIX.md、backend/MANUAL_LOMBOK_INSTALL.md、backend/FINAL_FIX.md、backend/TROUBLESHOOTING.md、backend/QUICK_START.md

- Java 版本
  - 推荐使用 Java 17，避免 Maven 插件与 repackage 兼容性问题
  - 如必须使用 Java 24：禁用 repackage，使用 `spring-boot:run` 直接运行
- Lombok
  - 指定版本与注解处理器配置，必要时手动安装 edge-SNAPSHOT
  - IDE 需启用 Annotation Processing
- 常见命令
  - 清理与编译：`mvn clean compile -U`
  - 运行：`mvn spring-boot:run`
  - 依赖镜像：配置阿里云 Maven 镜像

---

## 附：关键端点速览（书籍推送）

```
GET  /api/books                        # 分页推荐 (page, size, sortBy)
GET  /api/books/all                    # 全量推荐（不分页）
GET  /api/books/search?keyword=...     # 搜索书籍
GET  /api/books/category/{category}    # 分类
GET  /api/books/{id}                   # 详情
```

---

## 2025-11-21 晚间更新摘要

- **日记功能增强 (Diary Enhancements)**
  - **智能配图 (Smart Meme)**: 集成 RAG (Retrieval-Augmented Generation) 技术，基于本地 Ollama 嵌入模型 + 余弦相似度算法，从 `ChineseBQB` 表情包库中自动匹配与日记内容最相关的表情包。
  - **导出功能 (Export)**: 新增导出 PDF 和 Word (.docx) 功能，支持将日记内容及智能配图一并导出。
  - **交互优化**: 新增“重新匹配”功能，允许用户在不满意时重新获取随机相关表情包。

- **问题修复 (Bug Fixes)**
  - **图片持久化**: 修复了日记更新时图片 URL 未保存到 MongoDB 的问题。
  - **导出图片显示**: 修复了 PDF/Word 导出时因 URL 编码问题导致中文路径图片无法下载显示的问题；增加了图片自动缩放逻辑以适应文档页面。
  - **GitHub API 限制**: 优化了 `MemeService` 的 WebClient 配置，增加了缓冲区大小 (10MB) 以处理大型 GitHub Tree 响应。
  - **依赖修复**: 解决了 `pdf-asian` 缺失问题，切换至 `itext-asian` 以支持 PDF 中文渲染。

---

最后更新：2025-11-21


